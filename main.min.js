let t,o,i;function a(){L.GeoJSON.include({setFilter:function(e,t){return this.options.filter=t,this.clearLayers(),this.addData(e),this}}),t=L.map("map",{center:[51.65892,6.41601],zoom:5,scrollWheelZoom:!1,zoomControl:!1}),L.control.zoom({position:"topright"}).addTo(t),t.light=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}),t.green=L.tileLayer("https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=9a85f60a13be4bf7bed59b5ffc0f4d86",{attribution:'Maps &copy; <a href="https://www.thunderforest.com">Thunderforest</a>, Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}).addTo(t),t.sidebar=L.control.sidebar("sidebar",{position:"left"}).addTo(t),t.on("focus",()=>{t.scrollWheelZoom.enable()}),t.on("blur",()=>{t.scrollWheelZoom.disable()}),t.on("zoomend",(function(e){for(type in tt)e.target._zoom>7&&!tt.isBack?(tt[type].bringToBack(),tt[type].isBack=!0):(tt[type].bringToFront(),tt[type].isBack=!1)}))}function r(){o=d3.format(",.1f"),i=d3.format(",.3f")}let p,u,m={"CO2, AIR":"rgb(241, 177, 48)","CO, AIR":"rgb(234,110,57)"},y={"chemical parks":"rgb(0,168,189)","polyol plants":"rgb(12,168,118)","steel mills":"yellow"},g={"Manufacture of basic iron and steel and of ferro-alloys":{style:"nace-iron",color:"#ff0000",looping:!0,catalytic:!0,active:!0},"Manufacture of other inorganic basic chemicals":{style:"nace-inorganic",color:"rgb(214,70,111)",looping:!0,catalytic:!0,active:!0},"Production of electricity":{style:"nace-electricity",color:"rgb(190,85,153)",looping:!0,catalytic:!1,active:!0},"Extraction of natural gas":{style:"nace-ng",color:"rgb(151,133,176)",looping:!0,catalytic:!1,active:!0},"Manufacture of refined petroleum products":{style:"nace-petroleum",color:"rgb(103,155,186)",looping:!0,catalytic:!1,active:!0},"Manufacture of cement":{style:"nace-cement",color:"#5a6067",looping:!0,catalytic:!1,active:!0},"Manufacture of lime and plaster":{style:"nace-lime",color:"#000000",looping:!0,catalytic:!1,active:!0},"Manufacture of fertilisers and nitrogen compounds":{style:"nace-fertilisers",color:"#938e99",looping:!0,catalytic:!1,active:!0}},h={emissions:{gasType:{"CO2, AIR":{color:"rgb(241, 177, 48)",filterButton:document.getElementById("pollutant-filter-CO2-button")},"CO, AIR":{color:"rgb(234,110,57)",filterButton:document.getElementById("pollutant-filter-CO-button")}},naceCategories:{"Manufacture of basic iron and steel and of ferro-alloys":{style:"nace-iron",color:"#ff0000",looping:!0,catalytic:!0,active:!0},"Manufacture of other inorganic basic chemicals":{style:"nace-inorganic",color:"rgb(214,70,111)",looping:!0,catalytic:!0,active:!0},"Production of electricity":{style:"nace-electricity",color:"rgb(190,85,153)",looping:!0,catalytic:!1,active:!0},"Extraction of natural gas":{style:"nace-ng",color:"rgb(151,133,176)",looping:!0,catalytic:!1,active:!0},"Manufacture of refined petroleum products":{style:"nace-petroleum",color:"rgb(103,155,186)",looping:!0,catalytic:!1,active:!0},"Manufacture of cement":{style:"nace-cement",color:"#5a6067",looping:!0,catalytic:!1,active:!0},"Manufacture of lime and plaster":{style:"nace-lime",color:"#000000",looping:!0,catalytic:!1,active:!0},"Manufacture of fertilisers and nitrogen compounds":{style:"nace-fertilisers",color:"#938e99",looping:!0,catalytic:!1,active:!0}}}},v=document.getElementById("compat-filter-manual-button"),b=document.getElementById("compat-filter-loop-button");compatFilterCatButton=document.getElementById("compat-filter-cat-button"),compatFilterButtons=[v,b,compatFilterCatButton];let E=document.getElementById("pollutant-filter-CO2-button"),C=document.getElementById("pollutant-filter-CO-button"),k=document.getElementsByClassName("nace-button"),A=document.getElementById("sumCO2"),I=document.getElementById("sumCO"),R=document.getElementById("sumCO2combined"),O=document.getElementById("sumCOcombined"),w=document.getElementById("nace-deselect-all");function M(e){if(N(e.target),e.target==compatFilterCatButton)for(name in g)g[name].active=g[name].catalytic;else if(e.target==b)for(name in g)g[name].active=g[name].looping;B(),ce()}E.style.background=m["CO2, AIR"],C.style.background=m["CO, AIR"];for(var F=0;F<compatFilterButtons.length;F++)compatFilterButtons[F].addEventListener("click",M);function N(e){for(var t=0;t<compatFilterButtons.length;t++)compatFilterButtons[t].classList.remove("is-info");e.classList.add("is-info")}function B(){for(var e=0;e<k.length;e++){let t=k[e].id.replace("-filter-button","");g[t].active?k[e].classList.add("is-activated",g[t].style):k[e].classList.remove("is-activated",g[t].style)}}function T(e){return function(){e.classList.toggle("is-activated"),e.style.background=e.classList.contains("is-activated")?m[e.id.includes("CO2")?"CO2, AIR":"CO, AIR"]:"#fff",x(),P(e.id.includes("CO2")?"CO2, AIR":"CO, AIR")}}function P(e){t.hasLayer(et[e])?t.removeLayer(et[e]):t.addLayer(et[e])}function x(){let e=0,t=0,n=0,i=0;for(name in g)g[name].active&&(C.classList.contains("is-activated")&&(t+=p.stats.totals["CO, AIR"][name]),E.classList.contains("is-activated")&&(e+=p.stats.totals["CO2, AIR"][name]));for(f in p["CO, AIR"].features){let e=p["CO, AIR"].features[f].properties;C.classList.contains("is-activated")&&E.classList.contains("is-activated")&&g[e.NACEMainEconomicActivityName].active&&e.co2Amount&&e.co2Amount>0&&(n+=e.co2Amount,i+=e.MTonnes)}R.style.background="#ddc",O.style.background="#ddc",A.style.background="#ddc",I.style.background="#ddc",setTimeout((function(){A.style.background="#fff",I.style.background="#fff",R.style.background="#fff",O.style.background="#fff"}),500),A.textContent=o(e)+" Megatonnes/year",I.textContent=o(t)+" Megatonnes/year",R.textContent=o(n)+" Megatonnes/year",O.textContent=o(i)+" Megatonnes/year"}function j(){if("Deselect all"==w.text)for(name in N(v),w.text="Select all",g)g[name].active=!1;else for(name in N(b),w.text="Deselect all",g)g[name].active=!0;B(),ce()}E.addEventListener("click",T(E)),C.addEventListener("click",T(C)),w.addEventListener("click",j);let D=e=>{N(v),g[e.replace("-filter-button","")].active=!g[e.replace("-filter-button","")].active,B(),ce()};function S(){for(var e in g){let t=i(p.stats.totals["CO2, AIR"][e])+" Megatonnes CO2/year, "+i(p.stats.totals["CO, AIR"][e])+" Megatonnes CO/year";d3.select("#naceCategories").append("a").attr("id",e+"-filter-button").attr("class","button is-small is-activated is-fullwidth nace-button "+g[e].style).on("click",(e,t,n)=>{D(n[0].id)}).attr("title",t).text(e)}}let z=document.getElementById("distance-chemical-plant"),J=document.getElementById("polyol-filter-button"),Y=document.getElementById("chem-plant-filter-button"),$=document.getElementById("ethylene-filter-button"),U=document.getElementById("propylene-filter-button"),_=document.getElementById("steel-mill-button"),q=document.getElementById("steel-mill-filter-button"),X=document.getElementById("radius-filter-button"),Z=document.getElementById("ethylene-pipeline-button"),H=document.getElementById("propylene-pipeline-button"),Q={"chemical parks":Y,"polyol plants":J,"steel mills":_},W=document.getElementById("distance-chemical-plant-slider"),G=document.getElementById("distance-chemical-plant-slider-output"),V=document.getElementById("polyol-slider"),K=document.getElementById("polyol-slider-output"),ee=document.getElementById("size-filter-button"),te=()=>{J.classList.toggle("is-info"),t.hasLayer(tt["polyol plants"])?t.removeLayer(tt["polyol plants"]):t.addLayer(tt["polyol plants"]),ce()};J.addEventListener("click",te);let ne=()=>{Y.classList.toggle("is-info"),t.hasLayer(tt["chemical parks"])?t.removeLayer(tt["chemical parks"]):t.addLayer(tt["chemical parks"]),ce()};Y.addEventListener("click",ne);let oe=()=>{$.classList.toggle("is-info"),fe(),ce()};$.addEventListener("click",oe);let ie=()=>{U.classList.toggle("is-info"),fe(),ce()};U.addEventListener("click",ie);let ae=()=>{_.classList.toggle("is-info"),_.classList.contains("is-info")?(q.disabled=!1,t.addLayer(tt["steel mills"]),ce()):(q.disabled=!0,t.removeLayer(tt["steel mills"]),ce())};_.addEventListener("click",ae),q.disabled=!0;let se=()=>{q.classList.toggle("is-info"),fe(),ce()};function re(e){return{color:54==e.properties.type[1]?"green":"red"}}function le(e,n){e.target.classList.toggle("is-info"),e.target.classList.contains("is-info")?fetch("pipeline-"+n+".json").then(e=>e.json(),e=>{console.error(e)}).then(e=>{nt[n]=L.geoJson(e,{style:re}),nt[n].addTo(t)}):t.removeLayer(nt[n])}function ce(){let e=Y.classList.contains("is-info"),t=J.classList.contains("is-info");for(marker in et)et[marker].setFilter(p[marker],(function(n){let o=!0;return(o=g[n.properties.NACEMainEconomicActivityName].active)&&X.classList.contains("is-info")&&(o=e&&ue(n,"chemical parks")||t&&ue(n,"polyol plants"))&&ee.classList.contains("is-info")&&(o=pe(n)),o}));x(),ve()}function pe(e){let t=15*K.value/5e4,n=[];for(d in Y.classList.contains("is-info")&&n.push("chemical parks"),J.classList.contains("is-info")&&n.push("polyol plants"),q.classList.contains("is-info")&&n.push("steel mills"),e.properties.distances)for(d in e.properties.distances)if(e.properties.distances[d].distance<1e3*G.value)for(marker in tt)for(f in tt[marker]._layers){let e=tt[marker]._layers[f].feature;if(e.properties.FacilityName==d&&n.includes(e.properties.type)&&e.properties.availability["CO, AIR"]>t)return!0}return!1}function ue(e,t){if(e.properties.distances)for(d in e.properties.distances){let n=e.properties.distances[d];if(n.type==t&&n.distance<1e3*G.value)return!0}return!1}q.addEventListener("click",se),Z.addEventListener("click",e=>{le(e,"ethylene")}),H.addEventListener("click",e=>{le(e,"propylene")});let de=()=>{X.classList.toggle("is-info"),ce()};X.addEventListener("click",de);let me=()=>{ee.classList.toggle("is-info"),ee.classList.contains("is-info")?(X.classList.add("is-info"),V.disabled=!1):V.disabled=!0,fe(),ce()};function fe(){let e=ee.classList.contains("is-info"),t=$.classList.contains("is-info"),n=U.classList.contains("is-info"),o=q.classList.contains("is-info"),i=13.5*K.value/5e4;for(marker in tt)tt[marker].setFilter(u[marker],a=>(!e||a.properties.availability["CO, AIR"]>i)&&("polyol plants"==marker||o&&"steel mills"==marker||(!t||1==a.properties.hasEthyleneOxide||"1"==a.properties.hasEthyleneOxide)&&(!n||1==a.properties.hasPropyleneOxide||"1"==a.properties.hasPropyleneOxide)))}ee.addEventListener("click",me),W.value=W.getAttribute("value"),V.value=V.getAttribute("value"),W.addEventListener("input",(function(e){for(layer in G.value=e.target.value,tt)tt[layer].eachLayer(t=>(t.setPopupContent(dt(t.feature)),t.setRadius(1e3*e.target.value)));X.classList.contains("is-info")&&ce()})),V.addEventListener("input",(function(e){K.value=e.target.value,fe(),ce()}));let ye=document.getElementById("number-chem-parks"),ge=document.getElementById("number-polyol-plants"),he=document.getElementById("number-steel-mills");function ve(){ye.value=Y.classList.contains("is-info")?tt["chemical parks"].getLayers().length:0,ge.value=J.classList.contains("is-info")?tt["polyol plants"].getLayers().length:0,he.value=_.classList.contains("is-info")?tt["steel mills"].getLayers().length:0}let be=document.getElementById("map-layout-green"),Ee=document.getElementById("map-layout-light"),Le=document.getElementById("map-show-consumers"),Ce=document.getElementById("modify-consumers"),ke=document.getElementById("modal-modify-consumers"),Ae=document.getElementById("csv-chemical-parks"),Ie=document.getElementById("csv-polyol-plants"),Re=document.getElementById("renew-emissions"),Oe=document.getElementById("modify-consumers-create-link"),we=document.getElementById("modify-consumers-create-json"),Me=document.getElementById("modify-consumers-load-data"),Fe=document.getElementsByClassName("close-modal"),Ne=document.getElementById("reset-consumers");function Be(){be.classList.toggle("is-info"),Ee.classList.toggle("is-info"),be.classList.contains("is-info")?(t.removeLayer(t.light),t.addLayer(t.green)):(t.removeLayer(t.green),t.addLayer(t.light))}function Te(){if(Le.classList.toggle("is-info"),J.classList.remove("is-info"),Y.classList.remove("is-info"),_.classList.remove("is-info"),Le.classList.contains("is-info"))for(l in J.disabled=!1,Y.disabled=!1,_.disabled=!1,tt)t.addLayer(tt[l]);else for(l in J.disabled=!0,Y.disabled=!0,_.disabled=!0,q.disabled=!0,tt)t.removeLayer(tt[l])}function Pe(e,t){fetch(e).then(e=>e.text()).then(e=>t.value=e)}function xe(){ke.classList.toggle("is-active"),ke.dataset.isInitialized||(Pe("chemicalparks v2.csv",Ae),Pe("polyol plants europe v2.csv",Ie),ke.dataset.isInitialized=!0)}be.addEventListener("click",Be),Ee.addEventListener("click",Be),Le.addEventListener("click",Te),Ce.addEventListener("click",xe);for(let e=0;e<Fe.length;e++)Fe[e].addEventListener("click",xe);function je(){var e=document.createElement("script");e.onload=function(){ze().then(e=>{var t=LZString.compressToEncodedURIComponent(JSON.stringify(e));window.prompt("Copy to clipboard: Ctrl+C, Enter","https://carbon4pur.github.io/mapping/index.html?c="+t)})},e.src="vendor/lz-string.min.js",document.head.appendChild(e)}function De(e,t){var n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",t+".json"),document.body.appendChild(o),o.click(),o.remove()}function Se(){ze().then(e=>Je(p,e)).then(e=>{De(e.chemParks,"chemicalParks")})}function ze(){return new Promise(e=>{var t=document.createElement("script");t.onload=function(){let t={"chemical parks":Ae.value,"polyol plants":Ie.value},n={};for(type in t)csv2geojson.csv2geojson(t[type],{latfield:"latitude",lonfield:"longitude",delimiter:";"},(e,t)=>{e?console.error(e):n[type]=t});e(n)},t.src="vendor/csv2geojson.js",document.head.appendChild(t)})}function Je(t,n){return new Promise((o,i)=>{for(c in n)Ye(n[c].features);for(e in t)if(Ye(t[e].features),"stats"!=e)for(c in n)"stats"!=c&&$e(t[e].features,e,n[c].features,c,groupByType1=!0);o({emissions:t,chemParks:n})})}function Ye(e){for(let t in e)delete e[t].properties.distances}function $e(e,t,n,o){for(let t in e)for(let i in n){let a=e[t],s=n[i],r=Ue(a.geometry.coordinates[1],a.geometry.coordinates[0],s.geometry.coordinates[1],s.geometry.coordinates[0]);r<100001&&(a.properties.distances||(a.properties.distances={}),a.properties.distances[s.properties.FacilityName]={distance:r,type:o},s.properties.distances||(s.properties.distances={}),s.properties.distances[a.properties.FacilityName]={distance:r,type:a.properties.type,amount:a.properties.MTonnes})}}function Ue(e,t,n,o){var i=Math.PI/180,a=e*i,s=n*i,r=Math.sin((n-e)*i/2),l=Math.sin((o-t)*i/2),c=r*r+Math.cos(a)*Math.cos(s)*l*l;return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}function _e(){Me.classList.add("is-loading"),ze().then(e=>Je(p,e)).then(e=>{p=e.emissions,u=e.chemParks}).then(rt(u)).then(()=>{Me.classList.remove("is-loading"),ke.classList.remove("is-active")})}function qe(){Re.classList.add("is-loading"),window.sortedFeatures={stats:{totalMax:0,max:{},totals:{"CO2, AIR":{},"CO, AIR":{}},Description:"BEFORE CHANGING: PLEASE NOTE: the location for 'FJERNVARME FYN FYNSVÆRKET A/S' has to be changed from (9.80973039123284°, 5.33467590910096°) to 10.404647, 55.428245"}};var e=["CO2, AIR","CO, AIR"].map(Xe);Promise.all(e).then(e=>{for(let e=0;e<sortedFeatures["CO2, AIR"].features.length;e++){let t=sortedFeatures["CO2, AIR"].features[e];for(let e=0;e<sortedFeatures["CO, AIR"].features.length;e++){let n=sortedFeatures["CO, AIR"].features[e];Ve(n,t,!1)&&(n.properties.co2Amount=t.properties.MTonnes,t.properties.coAmount=n.properties.MTonnes)}}Je(sortedFeatures,u),console.log(sortedFeatures),De(sortedFeatures,"emissions"),Re.classList.remove("is-loading")})}Oe.addEventListener("click",je),we.addEventListener("click",Se),Me.addEventListener("click",_e),Ne.addEventListener("click",()=>{delete ke.dataset.isInitialized,lt()}),Re.addEventListener("click",qe);var Xe=function(e){return new Promise(t=>{sortedFeatures[e]={type:"FeatureCollection",features:[]};var n=Ze(e);fetch(n).then((function(e){return e.json()}),(function(e){console.log(e)})).then(e=>He(e)).then(n=>{sortedFeatures[e].features=n;let o=n.reduce((e,t)=>e.properties.MTonnes>t.properties.MTonnes?e:t).properties.MTonnes;sortedFeatures.stats.max[e]=o,sortedFeatures.stats.totalMax<o&&(sortedFeatures.stats.totalMax=o);for(let t=0;t<n.length;t++){let o=n[t];isNaN(sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName])&&(sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName]=0),sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName]+=o.properties.MTonnes}t(sortedFeatures)})})};function Ze(e="CO2, AIR"){return"https://cors-anywhere.herokuapp.com/http://semantic.eea.europa.eu/sparql?query="+encodeURIComponent('PREFIX eprtr: <http://prtr.ec.europa.eu/rdf/schema.rdf#>\nPREFIX facility: <http://prtr.ec.europa.eu/rdf/facility/>\nPREFIX wgs84: <http://www.w3.org/2003/01/geo/wgs84_pos#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX foaf: <http://xmlns.com/foaf/0.1/>\nSELECT ?FacilityName ?FacilityDetails ?CountryName ?Lat ?Long ?ReportingYear ?NACEMainEconomicActivityName ?PollutantName ?Quantity {\n  ?facility eprtr:facilityName ?FacilityName .\n  ?facility eprtr:inCountry ?country . ?country eprtr:name ?CountryName .\n  ?facility eprtr:latestReport ?latestReport . \n  ?facility wgs84:lat ?Lat . \n  ?facility wgs84:long ?Long .\n  ?facility foaf:isPrimaryTopicOf ?FacilityDetails .\n  ?latestReport eprtr:reportingYear ?ReportingYear .\n  ?latestReport eprtr:nACEActivity ?nACEActivity . ?nACEActivity eprtr:name ?NACEMainEconomicActivityName\n  values ?nACEActivity {\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/20.13>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/23.52>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/35.11>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/06.20>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/23.51>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/20.15>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/19.20>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/24.10>\n    \n  }\n  ?pollutantRelease eprtr:facilityReport ?latestReport .   \n  ?pollutantRelease rdfs:label ?PollutantName . \n  values ?PollutantName {"'+e+'"}  \n  ?pollutantRelease eprtr:totalQuantity ?Quantity . \n} \nORDER BY ?nACEActivity ?FacilityName ?ReportingYear\nLIMIT 10000\n\t')+"&format=application%2Fsparql-results%2Bjson&nrOfHits=10000"}function He(e){return Ke(e.results.bindings)}function Qe(e,t){return{type:"Point",coordinates:[parseFloat(e),parseFloat(t)]}}function We(e){return{CountryName:e.CountryName.value,FacilityName:e.FacilityName.value,FacilityDetails:e.FacilityDetails.value,ReportingYear:e.ReportingYear.value,MTonnes:e.Quantity.value/1e9,NACEMainEconomicActivityName:e.NACEMainEconomicActivityName.value,PollutantName:e.PollutantName.value}}function Ge(e){return{geometry:Qe(e.Long.value,e.Lat.value),properties:We(e),type:"Feature"}}function Ve(e,t,n=!0){return(e.properties.FacilityDetails==t.properties.FacilityDetails?1:0)+(e.properties.FacilityName==t.properties.FacilityName?1:0)+(e.properties.ReportingYear==t.properties.ReportingYear?1:0)+(e.properties.MTonnes==t.properties.MTonnes?1:0)>(n?3:2)}function Ke(e){for(var t=[],n=0;n<e.length;n++){var o=Ge(e[n]);t.some(e=>Ve(e,o))||t.push(o)}return t}var et={},tt={},nt={};function ot(e){return new Promise((n,o)=>{for(emission in e)if("stats"!=emission){for(f in e[emission].features)e[emission].features[f].properties.type=emission;et[emission]=L.geoJson(e[emission],{pointToLayer:function(t,n){return L.circleMarker(n,{radius:50*Math.sqrt(t.properties.MTonnes/e.stats.totalMax),color:m[t.properties.PollutantName],fillColor:g[t.properties.NACEMainEconomicActivityName].color,weight:1,opacity:.7,fillOpacity:.4}).bindPopup(it(t))}}).addTo(t)}p=e,n(e)})}function it(e){if(e.properties){let t="";e.properties.co2Amount&&(t+=i(e.properties.co2Amount)+" Megatonnes CO<sub>2</sub>/year"),e.properties.coAmount&&(t+=i(e.properties.coAmount)+" Megatonnes CO/year");let n=i(e.properties.MTonnes)+" Megatonnes ";n+="CO, AIR"==e.properties.type?"CO/year":"CO<sub>2</sub>/year";let o=ft(g[e.properties.NACEMainEconomicActivityName].color);return`<h2>${e.properties.FacilityName}</h2>\n                        ${e.properties.CountryName}                    \n                        <br><b><i>${e.properties.NACEMainEconomicActivityName}</i></b>\n                        <br>\n                        <div class='popup-em' style='background: ${o}'>\n                        Emissions:\n                        <br>${n}`+(""!=t?`<br />${t}`:"")+`</div>\n                        <br><br><a href="${e.properties.FacilityDetails}" target="_blank">More Facility details on E-PRTR page</a>`}console.log(e)}function at(e){return Je(p,e),new Promise((n,o)=>{for(type in e)"stats"!=type&&(tt[type]=ut(e,type).addTo(t),Q[type].classList.contains("is-info")||Q[type].click());u=e,n()})}function st(e){pt("vendor/lz-string.min.js",()=>{let t=LZString.decompressFromEncodedURIComponent(e);console.log(t,JSON.parse(t)),at(JSON.parse(t))})}function rt(e){return new Promise((n,o)=>{for(marker in tt)t.removeLayer(tt[marker]);tt={},gt.searchParams.get("c")?st(gt.searchParams.get("c")).then(n()):at(e).then(n())})}function lt(){return new Promise(e=>{fetch("chemicalParks.json").then(e=>e.json(),e=>{console.error(e)}).then(rt).then(()=>e())})}function ct(){return new Promise(t=>{u["steel mills"]?t():fetch("steelMills.json").then(e=>e.json(),e=>{console.error(e)}).then(n=>{for(e in u["steel mills"]={type:"FeatureCollection",features:[]},new_feats=u["steel mills"].features,p["CO, AIR"].features){let t=p["CO, AIR"].features[e];for(s in n.bof){let e=n.bof[s];t.properties.FacilityName==e&&new_feats.push(Et(t))}}for(e in p)$e(p[e].features,new_feats);tt["steel mills"]=ut(u,"steel mills"),t()})})}function pt(e,t){var n=document.head,o=document.createElement("script");o.type="text/javascript",o.src=e,o.onreadystatechange=t,o.onload=t,n.appendChild(o)}function ut(e,t){return L.geoJson(e[t],{pointToLayer:function(e,n){return e.properties.type=t,L.circle(n,1e3*G.value,{fillColor:y[e.properties.type],weight:0,fillOpacity:.4}).bindPopup(dt(e,t))}})}function dt(e){if(e.properties)return`<h2>${e.properties.FacilityName}</h2>\n                ${e.properties.CountryName}\n                <br><b><i class="${e.properties.type.replace(" ","-")+"-popup"}">${e.properties.type}</i></b>\n                <br>`+mt(e);console.log(e)}function mt(e){let t=e.properties;if(t.availability={"CO2, AIR":0,"CO, AIR":0},null!=t.distances)for(n in t.distances)t.distances[n].distance<1e3*G.value&&(t.availability[t.distances[n].type]+=t.distances[n].amount);return'<div class="popup-em" style="background:'+ft(y[e.properties.type])+'">Available emissions:<br>(in a radius of '+G.value+"&nbsp;km)<br>"+i(e.properties.availability["CO2, AIR"])+"&nbsp;Megatonnes CO<sub>2</sub>/year<br>"+i(e.properties.availability["CO, AIR"])+"&nbsp;Megatonnes CO/year</div>"}function ft(e,t=.6){let n=d3.color(e);return n.opacity=t,n}let yt=()=>{var e=d3.select("#scale").append("svg").attr("width",130).attr("height",75),t=d3.scaleSqrt().domain([0,p.stats.totalMax]).range([0,50]),n=[.1,5,20];e.selectAll("legend").data(n).enter().append("circle").attr("cx",38).attr("cy",(function(e){return 74-t(e)})).attr("r",(function(e){return t(e)})).style("fill","none").style("stroke","black").style("stroke-width","0.8").attr("stroke","black"),e.selectAll("legend").data(n).enter().append("line").attr("x1",(function(e){return 38+t(e)})).attr("x2",100).attr("y1",(function(e){return 74-t(e)})).attr("y2",(function(e){return 74-t(e)})).attr("stroke","black").style("stroke","black").style("stroke-width","0.8").style("stroke-dasharray","2,2"),e.selectAll("legend").data(n).enter().append("text").attr("x",(function(e){return 100+(e>=10?1:7)})).attr("y",(function(e){return 74-t(e)})).text((function(e){return o(e)})).style("font-size",10).attr("alignment-baseline","middle")};var gt=new URL(window.location.href);Ee.classList.contains("is-info")||"light"!=gt.searchParams.get("style")||Be(),document.addEventListener("DOMContentLoaded",e=>{a(),r(),fetch("emissions.json").then(e=>e.json(),e=>{console.error(e)}).then(ot).then(yt).then(S).then(x).then(lt).then(ct).then(Ct).then(ve)});const ht=(e,t,n=100,o="/")=>{const i=new Date(Date.now()+864e5*n).toUTCString();document.cookie=e+"="+encodeURIComponent(t)+"; expires="+i+"; path="+o},vt=e=>document.cookie.split("; ").reduce((t,n)=>{const o=n.split("=");return o[0]===e?decodeURIComponent(o[1]):t},""),bt=(e,t="/")=>{ht(e,"",-1,t)};function Et(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(t=new Date).setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,o=e.length;n<o;n++)t[n]=Et(e[n]);return t}if(e instanceof Object){for(var i in t={},e)e.hasOwnProperty(i)&&(t[i]=Et(e[i]));return t}throw Error("Unable to copy obj! Its type isn't supported.")}function Lt(){ht("no-tour","true"),introJs().exit()}function Ct(){vt("no-tour")||kt()}function kt(){var e=introJs();e.onexit(()=>t.sidebar.open("info-content")),e.setOptions({steps:[{intro:'Welcome to the Carbon4PUR mapping! If you want, you can follow this short introduction to see the main functions, or you can skip the tour.<br>\n                <button id="set-cookie-no-tour" class="introjs-button" title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><p>Don\'t show the tour again</p><p style="font-size: x-small; color: #746427;">&#9432; This will set a cookie.</p></button>'},{element:"#sidebar-close-info-span",intro:"This closes the sidebar so you can focus on the map."},{element:"#info-tab-li",intro:"Here you find information about the map and the data"},{element:"#emitter-tab-li",intro:"In this tab, you can filter the bubbles on the map representing emissions."},{element:"#consumer-tab-li",intro:"Here you can filter by chemical parks and polyol plants."},{element:"#legal-tab-li",intro:"All the background info and data as well as legal information about licenses and data."},{element:"#settings-tab-li",intro:"And if you like another map layout or restart the tour, click here."},{intro:"Click on any bubble to see more information about it.<br>That's it, now play with it."}],doneLabel:'<div title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><span>Done</span><span style="color: #746427;"> &#9432;</span><div>'}),introJs.fn.oncomplete(Lt),t.sidebar.open("info-content"),e.start(),document.getElementById("set-cookie-no-tour").addEventListener("click",Lt)}document.getElementById("show-intro").addEventListener("click",()=>{bt("no-tour"),kt()});