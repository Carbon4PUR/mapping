let t,n,i,o,a,s;function r(){L.GeoJSON.include({setFilter:function(e,t){return this.options.filter=t,this.clearLayers(),this.addData(e),this}}),t=L.map("map",{center:[51.65892,6.41601],zoom:5,scrollWheelZoom:!1,zoomControl:!1}),L.control.zoom({position:"topright"}).addTo(t),o=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}),a=L.tileLayer("https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=9a85f60a13be4bf7bed59b5ffc0f4d86",{attribution:'Maps &copy; <a href="https://www.thunderforest.com">Thunderforest</a>, Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}).addTo(t),s=L.control.sidebar("sidebar",{position:"left"}).addTo(t),t.on("focus",()=>{t.scrollWheelZoom.enable()}),t.on("blur",()=>{t.scrollWheelZoom.disable()}),t.on("zoomend",function(e){for(type in Oe)e.target._zoom>7&&!Oe.isBack?(Oe[type].bringToBack(),Oe[type].isBack=!0):(Oe[type].bringToFront(),Oe[type].isBack=!1)})}function c(){n=d3.format(",.1f"),i=d3.format(",.3f")}let p,u,m={Germany:"rgb(241, 177, 48)",Belgium:"rgb(234,110,57)",Netherlands:"rgb(0,110,57)"},y={"chemical parks":"rgb(0,168,189)","polyol plants":"rgb(12,168,118)"},g={"Energy sector":{style:"nace-iron",color:"#ff0000",looping:!0,catalytic:!0,active:!0},"Productiona and processing of metals":{style:"nace-inorganic",color:"rgb(214,70,111)",looping:!0,catalytic:!0,active:!0},"Chemical industry":{style:"nace-electricity",color:"rgb(190,85,153)",looping:!0,catalytic:!1,active:!0},"Paper and wood production processing":{style:"nace-ng",color:"rgb(151,133,176)",looping:!0,catalytic:!1,active:!0},"Mineral industry":{style:"nace-petroleum",color:"rgb(103,155,186)",looping:!0,catalytic:!1,active:!0},"Waste and waste water management":{style:"nace-cement",color:"#5a6067",looping:!0,catalytic:!1,active:!0},"Other activities":{style:"nace-lime",color:"#000000",looping:!0,catalytic:!1,active:!0},"Animal and vegetable products from the food and beverage sector":{style:"nace-fertilisers",color:"#938e99",looping:!0,catalytic:!1,active:!0}},h=document.getElementById("reset-filters-button");function v(){if(compatFilterButtons[1].click(),I.classList.contains("is-activated")||P(I)(),E.classList.contains("is-activated")||P(E)(),Z.value=20,$.classList.contains("is-info")&&Q(),W.classList.contains("is-info")&&ee(),H.classList.contains("is-info")&&te(),_.value=5,G.value=5,document.createEvent){var e=document.createEvent("Event");e.initEvent("input"),Z.dispatchEvent(e)}}h.addEventListener("click",v);let b=document.getElementById("compat-filter-manual-button"),k=document.getElementById("compat-filter-loop-button");compatFilterCatButton=document.getElementById("compat-filter-cat-button"),compatFilterButtons=[b,k,compatFilterCatButton];let E=document.getElementById("pollutant-filter-CO2-button"),I=document.getElementById("pollutant-filter-CO-button"),C=document.getElementsByClassName("nace-button"),B=document.getElementById("sumCO2"),w=document.getElementById("sumCO"),O=document.getElementById("sumCO2combined"),A=document.getElementById("sumCOcombined"),M=document.getElementById("nace-deselect-all");function R(e){if(S(e.target),e.target==compatFilterCatButton)for(name in g)g[name].active=g[name].catalytic;else if(e.target==k)for(name in g)g[name].active=g[name].looping;x(),V()}E.style.background=m["CO2, AIR"],I.style.background=m["CO, AIR"];for(var T=0;T<compatFilterButtons.length;T++)compatFilterButtons[T].addEventListener("click",R);function S(e){for(var t=0;t<compatFilterButtons.length;t++)compatFilterButtons[t].classList.remove("is-info");e.classList.add("is-info")}function x(){for(var e=0;e<C.length;e++){let t=C[e].id.replace("-filter-button","");g[t].active?C[e].classList.add("is-activated",g[t].style):C[e].classList.remove("is-activated",g[t].style)}}function P(e){return function(){e.classList.toggle("is-activated"),e.style.background=e.classList.contains("is-activated")?m[e.id.includes("CO2")?"CO2, AIR":"CO, AIR"]:"#fff",N(),F(e.id.includes("CO2")?"CO2, AIR":"CO, AIR")}}function F(e){t.hasLayer(we[e])?t.removeLayer(we[e]):t.addLayer(we[e])}function N(){}function z(){if("Deselect all"==M.text)for(name in S(b),M.text="Select all",g)g[name].active=!1;else for(name in S(k),M.text="Deselect all",g)g[name].active=!0;x(),V()}E.addEventListener("click",P(E)),I.addEventListener("click",P(I)),M.addEventListener("click",z);let j=e=>{S(b),g[e.replace("-filter-button","")].active=!g[e.replace("-filter-button","")].active,x(),V()};function D(){for(var e in g)d3.select("#naceCategories").append("a").attr("id",e+"-filter-button").attr("class","button is-small is-activated is-fullwidth nace-button "+g[e].style).on("click",(e,t,n)=>{j(n[0].id)}).text(e)}let J=document.getElementById("distance-chemical-plant"),$=document.getElementById("polyol-filter-button"),U=document.getElementById("pipeline-filter-button"),W=document.getElementById("radius-filter-button"),Z=document.getElementById("distance-chemical-plant-slider"),q=document.getElementById("distance-chemical-plant-slider-output"),_=document.getElementById("polyol-slider"),G=document.getElementById("polyol-slider-output"),H=document.getElementById("size-filter-button"),Q=()=>{$.classList.toggle("is-info"),t.hasLayer(Oe["chemical parks"])?t.removeLayer(Oe["chemical parks"]):t.addLayer(Oe["chemical parks"]),V()};$.addEventListener("click",Q);let K=()=>{U.classList.toggle("is-info"),ne(),V()};function V(){for(marker in we)we[marker].setFilter(p[marker],function(e){let t=!0;return(t=g[e.properties.MainIASectorName].active)&&W.classList.contains("is-info")&&(t=!$.classList.contains("is-info")&&Y(e,"chemical parks")||Y(e,"polyol plants"))&&H.classList.contains("is-info")&&(t=X(e)),t});N(),ae()}function X(e){let t=15*G.value/5e4;for(d in e.properties.distances)for(paramStyle in e.properties.distances[d])if(e.properties.distances[d][paramStyle]<1e3*q.value)for(marker in Oe)if(!$.classList.contains("is-info")||"polyol plants"==marker)for(f in Oe[marker]._layers){let e=Oe[marker]._layers[f].feature;if(e.properties.FacilityName==paramStyle)return e.properties.availability["CO, AIR"]>t}return!1}function Y(e,t){let n=99999999;return e.properties.distances&&e.properties.distances[t]&&(n=Math.min(n,Object.entries(e.properties.distances[t]).reduce((e,[,t])=>Math.min(t,e),n))),n<1e3*q.value}U.addEventListener("click",K);let ee=()=>{W.classList.toggle("is-info"),V()};W.addEventListener("click",ee);let te=()=>{H.classList.toggle("is-info"),H.classList.contains("is-info")?(W.classList.add("is-info"),_.disabled=!1):_.disabled=!0,ne(),V()};function ne(){let e=H.classList.contains("is-info"),t=U.classList.contains("is-info"),n=15*G.value/5e4;for(marker in Oe)Oe[marker].setFilter(u[marker],i=>(!e||i.properties.availability["CO, AIR"]>n)&&(!t||1==i.properties.ePipeline))}H.addEventListener("click",te),Z.value=Z.getAttribute("value"),_.value=_.getAttribute("value"),Z.addEventListener("input",function(e){for(layer in q.value=e.target.value,Oe)Oe[layer].eachLayer(t=>(t.setPopupContent(Ne(t.feature,type)),t.setRadius(1e3*e.target.value)));W.classList.contains("is-info")&&V()}),_.addEventListener("input",function(e){G.value=e.target.value,ne(),V()});let ie=document.getElementById("number-chem-parks"),oe=document.getElementById("number-polyol-plants");function ae(){}let se=document.getElementById("map-layout-green"),re=document.getElementById("map-layout-light"),le=document.getElementById("map-show-consumers"),ce=document.getElementById("modify-consumers"),de=document.getElementById("modal-modify-consumers"),pe=document.getElementById("csv-chemical-parks"),ue=document.getElementById("csv-polyol-plants"),me=document.getElementById("modify-consumers-create-link"),fe=document.getElementById("modify-consumers-load-data"),ye=document.getElementsByClassName("close-modal"),ge=document.getElementById("reset-consumers");function he(){se.classList.toggle("is-info"),re.classList.toggle("is-info"),se.classList.contains("is-info")?(t.removeLayer(o),t.addLayer(a)):(t.removeLayer(a),t.addLayer(o))}function ve(){if(le.classList.toggle("is-info"),$.classList.remove("is-info"),le.classList.contains("is-info"))for(l in $.disabled=!1,Oe)t.addLayer(Oe[l]);else for(l in $.disabled=!0,Oe)t.removeLayer(Oe[l])}function be(e,t){fetch(e).then(e=>e.text()).then(e=>t.value=e)}function ke(){de.classList.toggle("is-active"),de.dataset.isInitialized||(be("chemicalparks.csv",pe),be("polyol plants europe v2.csv",ue),de.dataset.isInitialized=!0)}se.addEventListener("click",he),re.addEventListener("click",he),le.addEventListener("click",ve),ce.addEventListener("click",ke);for(let e=0;e<ye.length;e++)ye[e].addEventListener("click",ke);function Le(){var e=document.createElement("script");e.onload=function(){Ee().then(e=>{var t=LZString.compressToEncodedURIComponent(JSON.stringify(e));window.prompt("Copy to clipboard: Ctrl+C, Enter","https://carbon4pur.github.io/mapping/index.html?c="+t)})},e.src="vendor/lz-string.min.js",document.head.appendChild(e)}function Ee(){return new Promise(e=>{var t=document.createElement("script");t.onload=function(){let t={"chemical parks":pe.value,"polyol plants":ue.value},n={};for(type in t)csv2geojson.csv2geojson(t[type],{latfield:"latitude",lonfield:"longitude",delimiter:";"},(e,t)=>{e?console.error(e):n[type]=t});u=n,e(n)},t.src="vendor/csv2geojson.js",document.head.appendChild(t)})}function Ie(e,t){return new Promise((n,i)=>{for(eCat in e)if("stats"!=eCat)for(f in e[eCat].features){let n=e[eCat].features[f];for(cat in delete n.properties.distances,t)for(park in t[cat].features){let e=t[cat].features[park],i=Ce(n.geometry.coordinates[1],n.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[0]);i<100001&&(n.properties.distances||(n.properties.distances={}),n.properties.distances[cat]||(n.properties.distances[cat]={}),n.properties.distances[cat][e.properties.FacilityName]=i)}}console.log(p=e),n(e)})}function Ce(e,t,n,i){var o=Math.PI/180,a=e*o,s=n*o,r=Math.sin((n-e)*o/2),l=Math.sin((i-t)*o/2),c=r*r+Math.cos(a)*Math.cos(s)*l*l;return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}function Be(){fe.classList.add("is-loading"),Ee().then(e=>Ie(p,e)).then(e=>Ae()).then(e=>Se(u)).then(()=>{fe.classList.remove("is-loading"),de.classList.remove("is-active")})}me.addEventListener("click",Le),fe.addEventListener("click",Be),ge.addEventListener("click",()=>{delete de.dataset.isInitialized,xe()});var we={},Oe={};function Ae(e){return new Promise((n,i)=>{console.log(e);for(var o,a={},s=e["CO2, AIR"].features,r=[],l=0;o=s[l++];){var c=o.properties.MainIASectorName;c in a||(a[c]=1,r.push(c))}for(emission in console.log(r),e)if("stats"!=emission){for(f in e[emission].features)e[emission].features[f].properties.type=emission;we[emission]=L.geoJson(e[emission],{pointToLayer:function(t,n){return L.circleMarker(n,{radius:50*Math.sqrt(t.properties["TotalQuantity [kg/year]"]/e.stats.totalMax/1e9),color:m[t.properties.CountryName],fillColor:g[t.properties.MainIASectorName].color,weight:2,opacity:.7,fillOpacity:.4}).bindPopup(Me(t))}}).addTo(t)}p=e,n(e)})}function Me(e){if(e.properties){let t=i(e.properties["TotalQuantity [kg/year]"])+" Megatonnes CO<sub>2</sub>/year",n=je("blue");return`<h2>${e.properties.FacilityName}</h2>\n                        ${e.properties.CountryName}                    \n                        <br><b><i>${e.properties.NACEMainEconomicActivityName}</i></b>\n                        <br>\n                        <div class='popup-em' style='background: ${n}'>\n                        Emissions:\n                        <br />${t}</div>`}console.log(e)}function Re(n){return new Promise((i,o)=>{for(emission in p)if("stats"!=emission)for(f in p[emission].features){let t=p[emission].features[f];if(t.properties.distances)for(e in t.properties.distances)for(chem in t.properties.distances[e])for(paramStyle in n[e].features)n[e].features[paramStyle].properties.FacilityName==chem&&(n[e].features[paramStyle].properties.distances||(n[e].features[paramStyle].properties.distances=[]),n[e].features[paramStyle].properties.distances.push({name:t.properties.FacilityName,distance:t.properties.distances[e][chem],type:emission,value:t.properties.MTonnes}))}for(type in n)"stats"!=type&&(Oe[type]=Fe(n,type).addTo(t));u=n,i()})}function Te(e){Pe("vendor/lz-string.min.js",()=>{let t=LZString.decompressFromEncodedURIComponent(e);console.log(t,JSON.parse(t)),Re(JSON.parse(t))})}function Se(e){return new Promise((n,i)=>{for(marker in Oe)t.removeLayer(Oe[marker]);Oe={},Je.searchParams.get("c")?Te(Je.searchParams.get("c")).then(n()):Re(e).then(n())})}function xe(){return new Promise(e=>{fetch("chemicalParks.json").then(e=>e.json(),e=>{console.error(e)}).then(Se).then(()=>e())})}function Pe(e,t){var n=document.head,i=document.createElement("script");i.type="text/javascript",i.src=e,i.onreadystatechange=t,i.onload=t,n.appendChild(i)}function Fe(e,t){return L.geoJson(e[t],{pointToLayer:function(e,n){return e.properties.type=t,L.circle(n,1e3*q.value,{fillColor:y[e.properties.type],weight:0,fillOpacity:.4}).bindPopup(Ne(e,t))}})}function Ne(e,t){if(e.properties)return`<h2>${e.properties.FacilityName}</h2>\n                ${e.properties.Country}\n                <br><b><i class="${t.replace(" ","-")+"-popup"}">${"chemical parks"===t?"Chemical park":"Polyol plant"}</i></b>\n                <br>`+ze(e,t);console.log(e)}function ze(t,n){let o=t.properties;if(o.availability={"CO2, AIR":0,"CO, AIR":0},null!=o.distances)for(e in o.distances)o.distances[e].distance<1e3*q.value&&(o.availability[o.distances[e].type]+=o.distances[e].value);return'<div class="popup-em" style="background:'+je(y[n])+'">Available emissions:<br>(in a radius of '+q.value+"&nbsp;km)<br>"+i(t.properties.availability["CO2, AIR"])+"&nbsp;Megatonnes CO<sub>2</sub>/year<br>"+i(t.properties.availability["CO, AIR"])+"&nbsp;Megatonnes CO/year</div>"}function je(e,t=.6){let n=d3.color(e);return n.opacity=t,n}let De=()=>{var e=d3.select("#scale").append("svg").attr("width",130).attr("height",75),t=d3.scaleSqrt().domain([0,p.stats.totalMax]).range([0,50]),i=[.1,5,20];e.selectAll("legend").data(i).enter().append("circle").attr("cx",38).attr("cy",function(e){return 74-t(e)}).attr("r",function(e){return t(e)}).style("fill","none").style("stroke","black").style("stroke-width","0.8").attr("stroke","black"),e.selectAll("legend").data(i).enter().append("line").attr("x1",function(e){return 38+t(e)}).attr("x2",100).attr("y1",function(e){return 74-t(e)}).attr("y2",function(e){return 74-t(e)}).attr("stroke","black").style("stroke","black").style("stroke-width","0.8").style("stroke-dasharray","2,2"),e.selectAll("legend").data(i).enter().append("text").attr("x",function(e){return 100+(e>=10?1:7)}).attr("y",function(e){return 74-t(e)}).text(function(e){return n(e)}).style("font-size",10).attr("alignment-baseline","middle")};var Je=new URL(window.location.href);re.classList.contains("is-info")||"light"!=Je.searchParams.get("style")||he(),document.addEventListener("DOMContentLoaded",e=>{r(),c(),fetch("emissions.json").then(e=>e.json(),e=>{console.error(e)}).then(Ae).then(De).then(D).then(N).then(xe)});const $e=(e,t,n=100,i="/")=>{const o=new Date(Date.now()+864e5*n).toUTCString();document.cookie=e+"="+encodeURIComponent(t)+"; expires="+o+"; path="+i},Ue=e=>document.cookie.split("; ").reduce((t,n)=>{const i=n.split("=");return i[0]===e?decodeURIComponent(i[1]):t},""),We=(e,t="/")=>{$e(e,"",-1,t)};function Ze(){$e("no-tour","true"),introJs().exit()}function qe(){Ue("no-tour")||_e()}function _e(){var e=introJs();e.onexit(()=>s.open("info-content")),e.setOptions({steps:[{intro:'Welcome to the Carbon4PUR mapping! If you want, you can follow this short introduction to see the main functions, or you can skip the tour.<br>\n                <button id="set-cookie-no-tour" class="introjs-button" title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><p>Don\'t show the tour again</p><p style="font-size: x-small; color: #746427;">&#9432; This will set a cookie.</p></button>'},{element:"#sidebar-close-info-span",intro:"This closes the sidebar so you can focus on the map."},{element:"#info-tab-li",intro:"Here you find information about the map and the data"},{element:"#emitter-tab-li",intro:"In this tab, you can filter the bubbles on the map representing emissions."},{element:"#consumer-tab-li",intro:"Here you can filter by chemical parks and polyol plants."},{element:"#legal-tab-li",intro:"All the background info and data as well as legal information about licenses and data."},{element:"#settings-tab-li",intro:"And if you like another map layout or restart the tour, click here."},{intro:"Click on any bubble to see more information about it.<br>That's it, now play with it."}],doneLabel:'<div title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><span>Done</span><span style="color: #746427;"> &#9432;</span><div>'}),introJs.fn.oncomplete(Ze),s.open("info-content"),e.start(),document.getElementById("set-cookie-no-tour").addEventListener("click",Ze)}document.getElementById("show-intro").addEventListener("click",()=>{We("no-tour"),_e()});