let t,o,r;function i(){L.GeoJSON.include({setFilter:function(e,t){return this.options.filter=t,this.clearLayers(),this.addData(e),this}}),t=L.map("map",{center:[51.65892,6.41601],zoom:5,scrollWheelZoom:!1,zoomControl:!1}),L.control.zoom({position:"topright"}).addTo(t),t.light=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}),t.green=L.tileLayer("https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=9a85f60a13be4bf7bed59b5ffc0f4d86",{attribution:'Maps &copy; <a href="https://www.thunderforest.com">Thunderforest</a>, Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}).addTo(t),t.sidebar=L.control.sidebar("sidebar",{position:"left"}).addTo(t),t.on("focus",()=>{t.scrollWheelZoom.enable()}),t.on("blur",()=>{t.scrollWheelZoom.disable()}),t.on("zoomend",(function(e){for(type in q)e.target._zoom>7&&!q.isBack?(q[type].bringToBack(),q[type].isBack=!0):(q[type].bringToFront(),q[type].isBack=!1)}))}function a(){o=d3.format(",.1f"),r=d3.format(",.3f")}let s=document.getElementById("map-layout-green"),l=document.getElementById("map-layout-light"),p=document.getElementById("modify-consumers"),u=document.getElementById("modal-modify-consumers"),d=document.getElementById("csv-chemical-parks"),m=document.getElementById("csv-polyol-plants"),y=document.getElementById("renew-emissions"),h=document.getElementById("modify-consumers-create-link"),g=document.getElementById("modify-consumers-create-json"),b=document.getElementById("modify-consumers-load-data"),v=document.getElementsByClassName("close-modal"),E=document.getElementById("reset-consumers");function C(){s.classList.toggle("is-info"),l.classList.toggle("is-info"),s.classList.contains("is-info")?(t.removeLayer(t.light),t.addLayer(t.green)):(t.removeLayer(t.green),t.addLayer(t.light))}function A(e,t){fetch(e).then(e=>e.text()).then(e=>t.value=e)}function k(){u.classList.toggle("is-active"),u.dataset.isInitialized||(A("chemicalparks v2.csv",d),A("polyol plants europe v2.csv",m),u.dataset.isInitialized=!0)}s.addEventListener("click",C),l.addEventListener("click",C),p.addEventListener("click",k);for(let e=0;e<v.length;e++)v[e].addEventListener("click",k);function w(){var e=document.createElement("script");e.onload=function(){N().then(e=>{var t=LZString.compressToEncodedURIComponent(JSON.stringify(e));window.prompt("Copy to clipboard: Ctrl+C, Enter","https://carbon4pur.github.io/mapping/index.html?c="+t)})},e.src="vendor/lz-string.min.js",document.head.appendChild(e)}function R(e,t){var n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",t+".json"),document.body.appendChild(o),o.click(),o.remove()}function F(){N().then(e=>I(globalEmissionData,e)).then(e=>{R(e.chemParks,"chemicalParks")})}function N(){return new Promise(e=>{var t=document.createElement("script");t.onload=function(){let t={"chemical parks":d.value,"polyol plants":m.value},n={};for(type in t)csv2geojson.csv2geojson(t[type],{latfield:"latitude",lonfield:"longitude",delimiter:";"},(e,t)=>{e?console.error(e):n[type]=t});e(n)},t.src="vendor/csv2geojson.js",document.head.appendChild(t)})}function I(t,n){return new Promise((o,r)=>{for(c in n)M(n[c].features);for(e in t)if(M(t[e].features),"stats"!=e)for(c in n)"stats"!=c&&T(t[e].features,e,n[c].features,c,groupByType1=!0);o({emissions:t,chemParks:n})})}function M(e){for(let t in e)delete e[t].properties.distances}function T(e,t,n,o){for(let t in e)for(let r in n){let i=e[t],a=n[r],s=O(i.geometry.coordinates[1],i.geometry.coordinates[0],a.geometry.coordinates[1],a.geometry.coordinates[0]);s<100001&&(i.properties.distances||(i.properties.distances={}),i.properties.distances[a.properties.FacilityName]={distance:s,type:o},a.properties.distances||(a.properties.distances={}),a.properties.distances[i.properties.FacilityName]={distance:s,type:i.properties.type,amount:i.properties.MTonnes})}}function O(e,t,n,o){var r=Math.PI/180,i=e*r,a=n*r,s=Math.sin((n-e)*r/2),l=Math.sin((o-t)*r/2),c=s*s+Math.cos(i)*Math.cos(a)*l*l;return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}function P(){b.classList.add("is-loading"),N().then(e=>I(globalEmissionData,e)).then(e=>{globalEmissionData=e.emissions,globalChemicalData=e.chemParks}).then(_(globalChemicalData)).then(()=>{b.classList.remove("is-loading"),u.classList.remove("is-active")})}function D(){y.classList.add("is-loading"),window.sortedFeatures={stats:{totalMax:0,max:{},totals:{"CO2, AIR":{},"CO, AIR":{}},Description:"BEFORE CHANGING: PLEASE NOTE: the location for 'FJERNVARME FYN FYNSVÆRKET A/S' has to be changed from (9.80973039123284°, 5.33467590910096°) to 10.404647, 55.428245"}};var e=["CO2, AIR","CO, AIR"].map(x);Promise.all(e).then(e=>{for(let e=0;e<sortedFeatures["CO2, AIR"].features.length;e++){let t=sortedFeatures["CO2, AIR"].features[e];for(let e=0;e<sortedFeatures["CO, AIR"].features.length;e++){let n=sortedFeatures["CO, AIR"].features[e];Y(n,t,!1)&&(n.properties.co2Amount=t.properties.MTonnes,t.properties.coAmount=n.properties.MTonnes)}}I(sortedFeatures,globalChemicalData),console.log(sortedFeatures),R(sortedFeatures,"emissions"),y.classList.remove("is-loading")})}h.addEventListener("click",w),g.addEventListener("click",F),b.addEventListener("click",P),E.addEventListener("click",()=>{delete u.dataset.isInitialized,G()}),y.addEventListener("click",D);var x=function(e){return new Promise(t=>{sortedFeatures[e]={type:"FeatureCollection",features:[]};var n=B(e);fetch(n).then((function(e){return e.json()}),(function(e){console.log(e)})).then(e=>j(e)).then(n=>{sortedFeatures[e].features=n;let o=n.reduce((e,t)=>e.properties.MTonnes>t.properties.MTonnes?e:t).properties.MTonnes;sortedFeatures.stats.max[e]=o,sortedFeatures.stats.totalMax<o&&(sortedFeatures.stats.totalMax=o);for(let t=0;t<n.length;t++){let o=n[t];isNaN(sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName])&&(sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName]=0),sortedFeatures.stats.totals[e][o.properties.NACEMainEconomicActivityName]+=o.properties.MTonnes}t(sortedFeatures)})})};function B(e="CO2, AIR"){return"https://cors-anywhere.herokuapp.com/http://semantic.eea.europa.eu/sparql?query="+encodeURIComponent('PREFIX eprtr: <http://prtr.ec.europa.eu/rdf/schema.rdf#>\nPREFIX facility: <http://prtr.ec.europa.eu/rdf/facility/>\nPREFIX wgs84: <http://www.w3.org/2003/01/geo/wgs84_pos#>\nPREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>\nPREFIX foaf: <http://xmlns.com/foaf/0.1/>\nSELECT ?FacilityName ?FacilityDetails ?CountryName ?Lat ?Long ?ReportingYear ?NACEMainEconomicActivityName ?PollutantName ?Quantity {\n  ?facility eprtr:facilityName ?FacilityName .\n  ?facility eprtr:inCountry ?country . ?country eprtr:name ?CountryName .\n  ?facility eprtr:latestReport ?latestReport . \n  ?facility wgs84:lat ?Lat . \n  ?facility wgs84:long ?Long .\n  ?facility foaf:isPrimaryTopicOf ?FacilityDetails .\n  ?latestReport eprtr:reportingYear ?ReportingYear .\n  ?latestReport eprtr:nACEActivity ?nACEActivity . ?nACEActivity eprtr:name ?NACEMainEconomicActivityName\n  values ?nACEActivity {\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/20.13>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/23.52>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/35.11>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/06.20>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/23.51>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/20.15>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/19.20>\n    <http://prtr.ec.europa.eu/rdf/nACEActivity/24.10>\n    \n  }\n  ?pollutantRelease eprtr:facilityReport ?latestReport .   \n  ?pollutantRelease rdfs:label ?PollutantName . \n  values ?PollutantName {"'+e+'"}  \n  ?pollutantRelease eprtr:totalQuantity ?Quantity . \n} \nORDER BY ?nACEActivity ?FacilityName ?ReportingYear\nLIMIT 10000\n\t')+"&format=application%2Fsparql-results%2Bjson&nrOfHits=10000"}function j(e){return $(e.results.bindings)}function S(e,t){return{type:"Point",coordinates:[parseFloat(e),parseFloat(t)]}}function z(e){return{CountryName:e.CountryName.value,FacilityName:e.FacilityName.value,FacilityDetails:e.FacilityDetails.value,ReportingYear:e.ReportingYear.value,MTonnes:e.Quantity.value/1e9,NACEMainEconomicActivityName:e.NACEMainEconomicActivityName.value,PollutantName:e.PollutantName.value}}function J(e){return{geometry:S(e.Long.value,e.Lat.value),properties:z(e),type:"Feature"}}function Y(e,t,n=!0){return(e.properties.FacilityDetails==t.properties.FacilityDetails?1:0)+(e.properties.FacilityName==t.properties.FacilityName?1:0)+(e.properties.ReportingYear==t.properties.ReportingYear?1:0)+(e.properties.MTonnes==t.properties.MTonnes?1:0)>(n?3:2)}function $(e){for(var t=[],n=0;n<e.length;n++){var o=J(e[n]);t.some(e=>Y(e,o))||t.push(o)}return t}var U={},q={},X={};function Z(e){return new Promise((n,o)=>{for(emission in e)if("stats"!=emission){for(f in e[emission].features)e[emission].features[f].properties.type=emission;U[emission]=L.geoJson(e[emission],{pointToLayer:function(t,n){return L.circleMarker(n,{radius:50*Math.sqrt(t.properties.MTonnes/e.stats.totalMax),color:"blue",fillColor:"blue",weight:1,opacity:.7,fillOpacity:.4}).bindPopup(H(t))}}).addTo(t)}globalEmissionData=e,n(e)})}function H(e){if(e.properties){let t="";e.properties.co2Amount&&(t+=r(e.properties.co2Amount)+" Megatonnes CO<sub>2</sub>/year"),e.properties.coAmount&&(t+=r(e.properties.coAmount)+" Megatonnes CO/year");let n=r(e.properties.MTonnes)+" Megatonnes ";n+="CO, AIR"==e.properties.type?"CO/year":"CO<sub>2</sub>/year";let o=ne("blue");return`<h2>${e.properties.FacilityName}</h2>\n                        ${e.properties.CountryName}                    \n                        <br><b><i>${e.properties.NACEMainEconomicActivityName}</i></b>\n                        <br>\n                        <div class='popup-em' style='background: ${o}'>\n                        Emissions:\n                        <br>${n}`+(""!=t?`<br />${t}`:"")+`</div>\n                        <br><br><a href="${e.properties.FacilityDetails}" target="_blank">More Facility details on E-PRTR page</a>`}console.log(e)}function Q(e){return I(globalEmissionData,e),new Promise((n,o)=>{for(type in e)"stats"!=type&&(q[type]=K(e,type).addTo(t));globalChemicalData=e,n()})}function W(e){V("vendor/lz-string.min.js",()=>{let t=LZString.decompressFromEncodedURIComponent(e);console.log(t,JSON.parse(t)),Q(JSON.parse(t))})}function _(e){return new Promise((n,o)=>{for(marker in q)t.removeLayer(q[marker]);q={},re.searchParams.get("c")?W(re.searchParams.get("c")).then(n()):Q(e).then(n())})}function G(){return new Promise(e=>{fetch("chemicalParks.json").then(e=>e.json(),e=>{console.error(e)}).then(_).then(()=>e())})}function V(e,t){var n=document.head,o=document.createElement("script");o.type="text/javascript",o.src=e,o.onreadystatechange=t,o.onload=t,n.appendChild(o)}function K(e,t){return L.geoJson(e[t],{pointToLayer:function(e,n){return e.properties.type=t,L.circle(n,1e3,{fillColor:"red",weight:0,fillOpacity:.4}).bindPopup(ee(e,t))}})}function ee(e){if(e.properties)return`<h2>${e.properties.FacilityName}</h2>\n                ${e.properties.CountryName}\n                <br><b><i class="${e.properties.type.replace(" ","-")+"-popup"}">${e.properties.type}</i></b>\n                <br>`+te(e);console.log(e)}function te(e){let t=e.properties;if(t.availability={"CO2, AIR":0,"CO, AIR":0},null!=t.distances)for(n in t.distances)t.distances[n].distance<1e3&&(t.availability[t.distances[n].type]+=t.distances[n].amount);return'<div class="popup-em" style="background:'+ne("red")+'">Available emissions:<br>(in a radius of 1&nbsp;km)<br>'+r(e.properties.availability["CO2, AIR"])+"&nbsp;Megatonnes CO<sub>2</sub>/year<br>"+r(e.properties.availability["CO, AIR"])+"&nbsp;Megatonnes CO/year</div>"}function ne(e,t=.6){let n=d3.color(e);return n.opacity=t,n}let oe=()=>{var e=d3.select("#scale").append("svg").attr("width",130).attr("height",75),t=d3.scaleSqrt().domain([0,globalEmissionData.stats.totalMax]).range([0,50]),n=[.1,5,20];e.selectAll("legend").data(n).enter().append("circle").attr("cx",38).attr("cy",(function(e){return 74-t(e)})).attr("r",(function(e){return t(e)})).style("fill","none").style("stroke","black").style("stroke-width","0.8").attr("stroke","black"),e.selectAll("legend").data(n).enter().append("line").attr("x1",(function(e){return 38+t(e)})).attr("x2",100).attr("y1",(function(e){return 74-t(e)})).attr("y2",(function(e){return 74-t(e)})).attr("stroke","black").style("stroke","black").style("stroke-width","0.8").style("stroke-dasharray","2,2"),e.selectAll("legend").data(n).enter().append("text").attr("x",(function(e){return 100+(e>=10?1:7)})).attr("y",(function(e){return 74-t(e)})).text((function(e){return o(e)})).style("font-size",10).attr("alignment-baseline","middle")};var re=new URL(window.location.href);l.classList.contains("is-info")||"light"!=re.searchParams.get("style")||C(),document.addEventListener("DOMContentLoaded",e=>{i(),a(),fetch("emissions.json").then(e=>e.json(),e=>{console.error(e)}).then(Z).then(oe).then(G)});const ie=(e,t,n=100,o="/")=>{const r=new Date(Date.now()+864e5*n).toUTCString();document.cookie=e+"="+encodeURIComponent(t)+"; expires="+r+"; path="+o},ae=e=>document.cookie.split("; ").reduce((t,n)=>{const o=n.split("=");return o[0]===e?decodeURIComponent(o[1]):t},""),se=(e,t="/")=>{ie(e,"",-1,t)};function le(e){var t;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(t=new Date).setTime(e.getTime()),t;if(e instanceof Array){t=[];for(var n=0,o=e.length;n<o;n++)t[n]=le(e[n]);return t}if(e instanceof Object){for(var r in t={},e)e.hasOwnProperty(r)&&(t[r]=le(e[r]));return t}throw Error("Unable to copy obj! Its type isn't supported.")}function ce(){ie("no-tour","true"),introJs().exit()}function pe(){ae("no-tour")||ue()}function ue(){var e=introJs();e.onexit(()=>t.sidebar.open("info-content")),e.setOptions({steps:[{intro:'Welcome to the Carbon4PUR mapping! If you want, you can follow this short introduction to see the main functions, or you can skip the tour.<br>\n                <button id="set-cookie-no-tour" class="introjs-button" title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><p>Don\'t show the tour again</p><p style="font-size: x-small; color: #746427;">&#9432; This will set a cookie.</p></button>'},{element:"#sidebar-close-info-span",intro:"This closes the sidebar so you can focus on the map."},{element:"#info-tab-li",intro:"Here you find information about the map and the data"},{element:"#emitter-tab-li",intro:"In this tab, you can filter the bubbles on the map representing emissions."},{element:"#consumer-tab-li",intro:"Here you can filter by chemical parks and polyol plants."},{element:"#legal-tab-li",intro:"All the background info and data as well as legal information about licenses and data."},{element:"#settings-tab-li",intro:"And if you like another map layout or restart the tour, click here."},{intro:"Click on any bubble to see more information about it.<br>That's it, now play with it."}],doneLabel:'<div title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><span>Done</span><span style="color: #746427;"> &#9432;</span><div>'}),introJs.fn.oncomplete(ce),t.sidebar.open("info-content"),e.start(),document.getElementById("set-cookie-no-tour").addEventListener("click",ce)}document.getElementById("show-intro").addEventListener("click",()=>{se("no-tour"),ue()});