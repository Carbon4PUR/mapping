let t,n,o,i,a,s;function r(){L.GeoJSON.include({setFilter:function(e,t){return this.options.filter=t,this.clearLayers(),this.addData(e),this}}),t=L.map("map",{center:[51.65892,6.41601],zoom:5,scrollWheelZoom:!1,zoomControl:!1}),L.control.zoom({position:"topright"}).addTo(t),i=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attribution">CARTO</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}),a=L.tileLayer("https://tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey=9a85f60a13be4bf7bed59b5ffc0f4d86",{attribution:'Maps &copy; <a href="https://www.thunderforest.com">Thunderforest</a>, Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="http://prtr.ec.europa.eu">E-PRTR</a>'}).addTo(t),s=L.control.sidebar("sidebar",{position:"left"}).addTo(t),t.on("focus",()=>{t.scrollWheelZoom.enable()}),t.on("blur",()=>{t.scrollWheelZoom.disable()}),t.on("zoomend",(function(e){for(type in Me)e.target._zoom>7&&!Me.isBack?(Me[type].bringToBack(),Me[type].isBack=!0):(Me[type].bringToFront(),Me[type].isBack=!1)}))}function c(){n=d3.format(",.1f"),o=d3.format(",.3f")}let u,p,m={"CO2, AIR":"rgb(241, 177, 48)","CO, AIR":"rgb(234,110,57)"},y={"chemical parks":"rgb(0,168,189)","polyol plants":"rgb(12,168,118)"},g={"Manufacture of basic iron and steel and of ferro-alloys":{style:"nace-iron",color:"#ff0000",looping:!0,catalytic:!0,active:!0},"Manufacture of other inorganic basic chemicals":{style:"nace-inorganic",color:"rgb(214,70,111)",looping:!0,catalytic:!0,active:!0},"Production of electricity":{style:"nace-electricity",color:"rgb(190,85,153)",looping:!0,catalytic:!1,active:!0},"Extraction of natural gas":{style:"nace-ng",color:"rgb(151,133,176)",looping:!0,catalytic:!1,active:!0},"Manufacture of refined petroleum products":{style:"nace-petroleum",color:"rgb(103,155,186)",looping:!0,catalytic:!1,active:!0},"Manufacture of cement":{style:"nace-cement",color:"#5a6067",looping:!0,catalytic:!1,active:!0},"Manufacture of lime and plaster":{style:"nace-lime",color:"#000000",looping:!0,catalytic:!1,active:!0},"Manufacture of fertilisers and nitrogen compounds":{style:"nace-fertilisers",color:"#938e99",looping:!0,catalytic:!1,active:!0}},h=document.getElementById("reset-filters-button");function b(){if(compatFilterButtons[1].click(),C.classList.contains("is-activated")||P(C)(),E.classList.contains("is-activated")||P(E)(),q.value=20,J.classList.contains("is-info")&&Q(),_.classList.contains("is-info")&&ne(),K.classList.contains("is-info")&&oe(),H.value=5,G.value=5,document.createEvent){var e=document.createEvent("Event");e.initEvent("input"),q.dispatchEvent(e)}}h.addEventListener("click",b);let v=document.getElementById("compat-filter-manual-button"),k=document.getElementById("compat-filter-loop-button");compatFilterCatButton=document.getElementById("compat-filter-cat-button"),compatFilterButtons=[v,k,compatFilterCatButton];let E=document.getElementById("pollutant-filter-CO2-button"),C=document.getElementById("pollutant-filter-CO-button"),I=document.getElementsByClassName("nace-button"),B=document.getElementById("sumCO2"),O=document.getElementById("sumCO"),A=document.getElementById("sumCO2combined"),w=document.getElementById("sumCOcombined"),M=document.getElementById("nace-deselect-all");function R(e){if(T(e.target),e.target==compatFilterCatButton)for(name in g)g[name].active=g[name].catalytic;else if(e.target==k)for(name in g)g[name].active=g[name].looping;N(),Y()}E.style.background=m["CO2, AIR"],C.style.background=m["CO, AIR"];for(var x=0;x<compatFilterButtons.length;x++)compatFilterButtons[x].addEventListener("click",R);function T(e){for(var t=0;t<compatFilterButtons.length;t++)compatFilterButtons[t].classList.remove("is-info");e.classList.add("is-info")}function N(){for(var e=0;e<I.length;e++){let t=I[e].id.replace("-filter-button","");g[t].active?I[e].classList.add("is-activated",g[t].style):I[e].classList.remove("is-activated",g[t].style)}}function P(e){return function(){e.classList.toggle("is-activated"),e.style.background=e.classList.contains("is-activated")?m[e.id.includes("CO2")?"CO2, AIR":"CO, AIR"]:"#fff",S(),F(e.id.includes("CO2")?"CO2, AIR":"CO, AIR")}}function F(e){t.hasLayer(we[e])?t.removeLayer(we[e]):t.addLayer(we[e])}function S(){let e=0,t=0,o=0,i=0;for(name in g)g[name].active&&(C.classList.contains("is-activated")&&(t+=u.stats.totals["CO, AIR"][name]),E.classList.contains("is-activated")&&(e+=u.stats.totals["CO2, AIR"][name]));for(f in u["CO, AIR"].features){let e=u["CO, AIR"].features[f].properties;C.classList.contains("is-activated")&&E.classList.contains("is-activated")&&g[e.NACEMainEconomicActivityName].active&&e.co2Amount&&e.co2Amount>0&&(o+=e.co2Amount,i+=e.MTonnes)}A.style.background="#ddc",w.style.background="#ddc",B.style.background="#ddc",O.style.background="#ddc",setTimeout((function(){B.style.background="#fff",O.style.background="#fff",A.style.background="#fff",w.style.background="#fff"}),500),B.textContent=n(e)+" Megatonnes/year",O.textContent=n(t)+" Megatonnes/year",A.textContent=n(o)+" Megatonnes/year",w.textContent=n(i)+" Megatonnes/year"}function z(){if("Deselect all"==M.text)for(name in T(v),M.text="Select all",g)g[name].active=!1;else for(name in T(k),M.text="Deselect all",g)g[name].active=!0;N(),Y()}E.addEventListener("click",P(E)),C.addEventListener("click",P(C)),M.addEventListener("click",z);let j=e=>{T(v),g[e.replace("-filter-button","")].active=!g[e.replace("-filter-button","")].active,N(),Y()};function $(){for(var e in g){let t=o(u.stats.totals["CO2, AIR"][e])+" Megatonnes CO2/year, "+o(u.stats.totals["CO, AIR"][e])+" Megatonnes CO/year";d3.select("#naceCategories").append("a").attr("id",e+"-filter-button").attr("class","button is-small is-activated is-fullwidth nace-button "+g[e].style).on("click",(e,t,n)=>{j(n[0].id)}).attr("title",t).text(e)}}let D=document.getElementById("distance-chemical-plant"),J=document.getElementById("polyol-filter-button"),U=document.getElementById("ethylene-filter-button"),Z=document.getElementById("propylene-filter-button"),_=document.getElementById("radius-filter-button"),q=document.getElementById("distance-chemical-plant-slider"),W=document.getElementById("distance-chemical-plant-slider-output"),H=document.getElementById("polyol-slider"),G=document.getElementById("polyol-slider-output"),K=document.getElementById("size-filter-button"),Q=()=>{J.classList.toggle("is-info"),t.hasLayer(Me["chemical parks"])?t.removeLayer(Me["chemical parks"]):t.addLayer(Me["chemical parks"]),Y()};J.addEventListener("click",Q);let V=()=>{U.classList.toggle("is-info"),ie(),Y()};U.addEventListener("click",V);let X=()=>{Z.classList.toggle("is-info"),ie(),Y()};function Y(){for(marker in we)we[marker].setFilter(u[marker],(function(e){let t=!0;return(t=g[e.properties.NACEMainEconomicActivityName].active)&&_.classList.contains("is-info")&&(t=!J.classList.contains("is-info")&&te(e,"chemical parks")||te(e,"polyol plants"))&&K.classList.contains("is-info")&&(t=ee(e)),t}));S(),re()}function ee(e){let t=15*G.value/5e4;for(d in e.properties.distances)for(paramStyle in e.properties.distances[d])if(e.properties.distances[d][paramStyle]<1e3*W.value)for(marker in Me)if(!J.classList.contains("is-info")||"polyol plants"==marker)for(f in Me[marker]._layers){let e=Me[marker]._layers[f].feature;if(e.properties.FacilityName==paramStyle)return e.properties.availability["CO, AIR"]>t}return!1}function te(e,t){let n=99999999;return e.properties.distances&&e.properties.distances[t]&&(n=Math.min(n,Object.entries(e.properties.distances[t]).reduce((e,[,t])=>Math.min(t,e),n))),n<1e3*W.value}Z.addEventListener("click",X);let ne=()=>{_.classList.toggle("is-info"),Y()};_.addEventListener("click",ne);let oe=()=>{K.classList.toggle("is-info"),K.classList.contains("is-info")?(_.classList.add("is-info"),H.disabled=!1):H.disabled=!0,ie(),Y()};function ie(){let e=K.classList.contains("is-info"),t=U.classList.contains("is-info"),n=Z.classList.contains("is-info"),o=15*G.value/5e4;for(marker in Me)Me[marker].setFilter(p[marker],i=>!(e&&!(i.properties.availability["CO, AIR"]>o)||t&&1!=i.properties.hasEthylene&&"1"!=i.properties.hasEthylene||n&&1!=i.properties.hasPropylene&&"1"!=i.properties.hasPropylene))}K.addEventListener("click",oe),q.value=q.getAttribute("value"),H.value=H.getAttribute("value"),q.addEventListener("input",(function(e){for(layer in W.value=e.target.value,Me)Me[layer].eachLayer(t=>(t.setPopupContent(je(t.feature,type)),t.setRadius(1e3*e.target.value)));_.classList.contains("is-info")&&Y()})),H.addEventListener("input",(function(e){G.value=e.target.value,ie(),Y()}));let ae=document.getElementById("number-chem-parks"),se=document.getElementById("number-polyol-plants");function re(){ae.value=J.classList.contains("is-info")?0:Me["chemical parks"].getLayers().length,se.value=Me["polyol plants"].getLayers().length}let le=document.getElementById("map-layout-green"),ce=document.getElementById("map-layout-light"),de=document.getElementById("map-show-consumers"),ue=document.getElementById("modify-consumers"),pe=document.getElementById("modal-modify-consumers"),me=document.getElementById("csv-chemical-parks"),fe=document.getElementById("csv-polyol-plants"),ye=document.getElementById("modify-consumers-create-link"),ge=document.getElementById("modify-consumers-load-data"),he=document.getElementsByClassName("close-modal"),be=document.getElementById("reset-consumers");function ve(){le.classList.toggle("is-info"),ce.classList.toggle("is-info"),le.classList.contains("is-info")?(t.removeLayer(i),t.addLayer(a)):(t.removeLayer(a),t.addLayer(i))}function ke(){if(de.classList.toggle("is-info"),J.classList.remove("is-info"),de.classList.contains("is-info"))for(l in J.disabled=!1,Me)t.addLayer(Me[l]);else for(l in J.disabled=!0,Me)t.removeLayer(Me[l])}function Le(e,t){fetch(e).then(e=>e.text()).then(e=>t.value=e)}function Ee(){pe.classList.toggle("is-active"),pe.dataset.isInitialized||(Le("chemicalparks.csv",me),Le("polyol plants europe v2.csv",fe),pe.dataset.isInitialized=!0)}le.addEventListener("click",ve),ce.addEventListener("click",ve),de.addEventListener("click",ke),ue.addEventListener("click",Ee);for(let e=0;e<he.length;e++)he[e].addEventListener("click",Ee);function Ce(){var e=document.createElement("script");e.onload=function(){Ie().then(e=>{var t=LZString.compressToEncodedURIComponent(JSON.stringify(e));window.prompt("Copy to clipboard: Ctrl+C, Enter","https://carbon4pur.github.io/mapping/index.html?c="+t)})},e.src="vendor/lz-string.min.js",document.head.appendChild(e)}function Ie(){return new Promise(e=>{var t=document.createElement("script");t.onload=function(){let t={"chemical parks":me.value,"polyol plants":fe.value},n={};for(type in t)csv2geojson.csv2geojson(t[type],{latfield:"latitude",lonfield:"longitude",delimiter:";"},(e,t)=>{e?console.error(e):n[type]=t});p=n,e(n)},t.src="vendor/csv2geojson.js",document.head.appendChild(t)})}function Be(e,t){return new Promise((n,o)=>{for(eCat in e)if("stats"!=eCat)for(f in e[eCat].features){let n=e[eCat].features[f];for(cat in delete n.properties.distances,t)for(park in t[cat].features){let e=t[cat].features[park],o=Oe(n.geometry.coordinates[1],n.geometry.coordinates[0],e.geometry.coordinates[1],e.geometry.coordinates[0]);o<100001&&(n.properties.distances||(n.properties.distances={}),n.properties.distances[cat]||(n.properties.distances[cat]={}),n.properties.distances[cat][e.properties.FacilityName]=o)}}console.log(u=e),n(e)})}function Oe(e,t,n,o){var i=Math.PI/180,a=e*i,s=n*i,r=Math.sin((n-e)*i/2),l=Math.sin((o-t)*i/2),c=r*r+Math.cos(a)*Math.cos(s)*l*l;return 2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))*6371e3}function Ae(){ge.classList.add("is-loading"),Ie().then(e=>Be(u,e)).then(e=>Re()).then(e=>Pe(p)).then(()=>{ge.classList.remove("is-loading"),pe.classList.remove("is-active")})}ye.addEventListener("click",Ce),ge.addEventListener("click",Ae),be.addEventListener("click",()=>{delete pe.dataset.isInitialized,Fe()});var we={},Me={};function Re(e){return new Promise((n,o)=>{for(emission in e)if("stats"!=emission){for(f in e[emission].features)e[emission].features[f].properties.type=emission;we[emission]=L.geoJson(e[emission],{pointToLayer:function(t,n){return L.circleMarker(n,{radius:50*Math.sqrt(t.properties.MTonnes/e.stats.totalMax),color:m[t.properties.PollutantName],fillColor:g[t.properties.NACEMainEconomicActivityName].color,weight:1,opacity:.7,fillOpacity:.4}).bindPopup(xe(t))}}).addTo(t)}u=e,n(e)})}function xe(e){if(e.properties){let t="";e.properties.co2Amount&&(t+=o(e.properties.co2Amount)+" Megatonnes CO<sub>2</sub>/year"),e.properties.coAmount&&(t+=o(e.properties.coAmount)+" Megatonnes CO/year");let n=o(e.properties.MTonnes)+" Megatonnes ";n+="CO, AIR"==e.properties.type?"CO/year":"CO<sub>2</sub>/year";let i=De(g[e.properties.NACEMainEconomicActivityName].color);return`<h2>${e.properties.FacilityName}</h2>\n                        ${e.properties.CountryName}                    \n                        <br><b><i>${e.properties.NACEMainEconomicActivityName}</i></b>\n                        <br>\n                        <div class='popup-em' style='background: ${i}'>\n                        Emissions:\n                        <br>${n}`+(""!=t?`<br />${t}`:"")+`</div>\n                        <br><br><a href="${e.properties.FacilityDetails}" target="_blank">More Facility details on E-PRTR page</a>`}console.log(e)}function Te(n){return new Promise((o,i)=>{for(emission in u)if("stats"!=emission)for(f in u[emission].features){let t=u[emission].features[f];if(t.properties.distances)for(e in t.properties.distances)for(chem in t.properties.distances[e])for(paramStyle in n[e].features)n[e].features[paramStyle].properties.FacilityName==chem&&(n[e].features[paramStyle].properties.distances||(n[e].features[paramStyle].properties.distances=[]),n[e].features[paramStyle].properties.distances.push({name:t.properties.FacilityName,distance:t.properties.distances[e][chem],type:emission,value:t.properties.MTonnes}))}for(type in n)"stats"!=type&&(Me[type]=ze(n,type).addTo(t));p=n,o()})}function Ne(e){Se("vendor/lz-string.min.js",()=>{let t=LZString.decompressFromEncodedURIComponent(e);console.log(t,JSON.parse(t)),Te(JSON.parse(t))})}function Pe(e){return new Promise((n,o)=>{for(marker in Me)t.removeLayer(Me[marker]);Me={},Ue.searchParams.get("c")?Ne(Ue.searchParams.get("c")).then(n()):Te(e).then(n())})}function Fe(){return new Promise(e=>{fetch("chemicalParks.json").then(e=>e.json(),e=>{console.error(e)}).then(Pe).then(()=>e())})}function Se(e,t){var n=document.head,o=document.createElement("script");o.type="text/javascript",o.src=e,o.onreadystatechange=t,o.onload=t,n.appendChild(o)}function ze(e,t){return L.geoJson(e[t],{pointToLayer:function(e,n){return e.properties.type=t,L.circle(n,1e3*W.value,{fillColor:y[e.properties.type],weight:0,fillOpacity:.4}).bindPopup(je(e,t))}})}function je(e,t){if(e.properties)return`<h2>${e.properties.FacilityName}</h2>\n                ${e.properties.Country}\n                <br><b><i class="${t.replace(" ","-")+"-popup"}">${"chemical parks"===t?"Chemical park":"Polyol plant"}</i></b>\n                <br>`+$e(e,t);console.log(e)}function $e(t,n){let i=t.properties;if(i.availability={"CO2, AIR":0,"CO, AIR":0},null!=i.distances)for(e in i.distances)i.distances[e].distance<1e3*W.value&&(i.availability[i.distances[e].type]+=i.distances[e].value);return'<div class="popup-em" style="background:'+De(y[n])+'">Available emissions:<br>(in a radius of '+W.value+"&nbsp;km)<br>"+o(t.properties.availability["CO2, AIR"])+"&nbsp;Megatonnes CO<sub>2</sub>/year<br>"+o(t.properties.availability["CO, AIR"])+"&nbsp;Megatonnes CO/year</div>"}function De(e,t=.6){let n=d3.color(e);return n.opacity=t,n}let Je=()=>{var e=d3.select("#scale").append("svg").attr("width",130).attr("height",75),t=d3.scaleSqrt().domain([0,u.stats.totalMax]).range([0,50]),o=[.1,5,20];e.selectAll("legend").data(o).enter().append("circle").attr("cx",38).attr("cy",(function(e){return 74-t(e)})).attr("r",(function(e){return t(e)})).style("fill","none").style("stroke","black").style("stroke-width","0.8").attr("stroke","black"),e.selectAll("legend").data(o).enter().append("line").attr("x1",(function(e){return 38+t(e)})).attr("x2",100).attr("y1",(function(e){return 74-t(e)})).attr("y2",(function(e){return 74-t(e)})).attr("stroke","black").style("stroke","black").style("stroke-width","0.8").style("stroke-dasharray","2,2"),e.selectAll("legend").data(o).enter().append("text").attr("x",(function(e){return 100+(e>=10?1:7)})).attr("y",(function(e){return 74-t(e)})).text((function(e){return n(e)})).style("font-size",10).attr("alignment-baseline","middle")};var Ue=new URL(window.location.href);ce.classList.contains("is-info")||"light"!=Ue.searchParams.get("style")||ve(),document.addEventListener("DOMContentLoaded",e=>{r(),c(),fetch("emissions.json").then(e=>e.json(),e=>{console.error(e)}).then(Re).then(Je).then($).then(S).then(Fe).then(He).then(re)});const Ze=(e,t,n=100,o="/")=>{const i=new Date(Date.now()+864e5*n).toUTCString();document.cookie=e+"="+encodeURIComponent(t)+"; expires="+i+"; path="+o},_e=e=>document.cookie.split("; ").reduce((t,n)=>{const o=n.split("=");return o[0]===e?decodeURIComponent(o[1]):t},""),qe=(e,t="/")=>{Ze(e,"",-1,t)};function We(){Ze("no-tour","true"),introJs().exit()}function He(){_e("no-tour")||Ge()}function Ge(){var e=introJs();e.onexit(()=>s.open("info-content")),e.setOptions({steps:[{intro:'Welcome to the Carbon4PUR mapping! If you want, you can follow this short introduction to see the main functions, or you can skip the tour.<br>\n                <button id="set-cookie-no-tour" class="introjs-button" title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><p>Don\'t show the tour again</p><p style="font-size: x-small; color: #746427;">&#9432; This will set a cookie.</p></button>'},{element:"#sidebar-close-info-span",intro:"This closes the sidebar so you can focus on the map."},{element:"#info-tab-li",intro:"Here you find information about the map and the data"},{element:"#emitter-tab-li",intro:"In this tab, you can filter the bubbles on the map representing emissions."},{element:"#consumer-tab-li",intro:"Here you can filter by chemical parks and polyol plants."},{element:"#legal-tab-li",intro:"All the background info and data as well as legal information about licenses and data."},{element:"#settings-tab-li",intro:"And if you like another map layout or restart the tour, click here."},{intro:"Click on any bubble to see more information about it.<br>That's it, now play with it."}],doneLabel:'<div title="This is the only cookie used on this site. If you don\'t want to use cookies, the tour will be shown on each reload. Click anywhere outside the tour to make it disappear."><span>Done</span><span style="color: #746427;"> &#9432;</span><div>'}),introJs.fn.oncomplete(We),s.open("info-content"),e.start(),document.getElementById("set-cookie-no-tour").addEventListener("click",We)}document.getElementById("show-intro").addEventListener("click",()=>{qe("no-tour"),Ge()});